<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Управление проектами (API Client)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
        }

        h1, h3 {
            color: #343a40;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        th, td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #e9ecef;
        }

        .form-container {
            padding: 20px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        input[type="text"], input[type="date"], select {
            width: 95%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        button {
            padding: 10px 15px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .message {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-weight: bold;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>

    <h1>Управление проектами</h1>
    <div id="message" style="display:none;"></div>

    <button class="btn-primary" onclick="showCreateForm()">Добавить новый проект</button>

    <div id="projectForm" class="form-container" style="display:none;">
        <h3 id="formTitle">Новый проект</h3>
        <input type="hidden" id="projectId">
        <div>
            <label for="projectName"><b>Название:</b></label>
            <input type="text" id="projectName" required>
        </div>
        <div>
            <label for="projectNumber"><b>Номер:</b></label>
            <input type="text" id="projectNumber" required>
        </div>
        <div>
            <label for="projectFundingOrg"><b>Организация-спонсор:</b></label>
            <input type="text" id="projectFundingOrg" required>
        </div>
        <div>
            <label for="projectStartDate"><b>Дата начала:</b></label>
            <input type="date" id="projectStartDate" required>
        </div>
        <div>
            <label for="projectLeaderId"><b>Руководитель:</b></label>
            <select id="projectLeaderId" required></select>
        </div>
        <button class="btn-primary" onclick="saveProject()">Сохранить</button>
        <button class="btn-secondary" onclick="hideForm()">Отмена</button>
    </div>

    <table id="projectsTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Название</th>
                <th>Номер</th>
                <th>Спонсор</th>
                <th>Дата начала</th>
                <th>Руководитель</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            <!-- Данные будут загружены сюда -->
        </tbody>
    </table>

    <script>
        const projectsApiUrl = "/api/ProjectsApi";
        const teachersApiUrl = "/api/TeachersApi";

        // --- ОСНОВНЫЕ ФУНКЦИИ ---

        // Загрузка и отображение проектов
        async function loadProjects() {
            try {
                const response = await fetch(projectsApiUrl);
                if (!response.ok) throw new Error(`Ошибка сети: ${response.statusText}`);
                const projects = await response.json();

                const tbody = document.querySelector("#projectsTable tbody");
                tbody.innerHTML = ""; // Очищаем таблицу перед заполнением

                projects.forEach(p => {
                    const formattedDate = new Date(p.startDate).toLocaleDateString('ru-RU');
                    tbody.innerHTML += `
                        <tr id="project-row-${p.projectId}">
                            <td>${p.projectId}</td>
                            <td>${p.name}</td>
                            <td>${p.number}</td>
                            <td>${p.fundingOrg}</td>
                            <td>${formattedDate}</td>
                            <td>${p.leaderName}</td>
                            <td>
                                <button class="btn-danger" onclick="deleteProject(${p.projectId})">Удалить</button>
                            </td>
                        </tr>`;
                });
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        // Сохранение (создание или обновление) проекта
        async function saveProject() {
            const projectId = document.getElementById('projectId').value;
            const isCreating = !projectId; // Если ID нет, значит создаем

            const projectData = {
                name: document.getElementById('projectName').value,
                number: document.getElementById('projectNumber').value,
                fundingOrg: document.getElementById('projectFundingOrg').value,
                startDate: document.getElementById('projectStartDate').value,
                leaderId: parseInt(document.getElementById('projectLeaderId').value)
            };

            // Простая валидация
            if (!projectData.name || !projectData.number || !projectData.fundingOrg || !projectData.startDate || isNaN(projectData.leaderId)) {
                showMessage('Все поля, кроме даты окончания, обязательны!', 'error');
                return;
            }

            const url = isCreating ? projectsApiUrl : `${projectsApiUrl}/${projectId}`;
            const method = isCreating ? 'POST' : 'PUT';

            // Для PUT-запроса добавляем ID в тело
            if (!isCreating) {
                projectData.projectId = parseInt(projectId);
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(projectData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Ошибка сохранения: ${errorText || response.statusText}`);
                }

                hideForm();
                await loadProjects();
                showMessage(isCreating ? 'Проект успешно создан!' : 'Проект успешно обновлен!', 'success');
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        // Удаление проекта
        async function deleteProject(id) {
            if (!confirm(`Вы уверены, что хотите удалить проект с ID ${id}?`)) return;

            try {
                 const response = await fetch(`${projectsApiUrl}/${id}`, { method: 'DELETE' });
                 if (!response.ok) throw new Error(`Ошибка удаления: ${response.statusText}`);

                 // Плавное удаление строки из таблицы
                 const rowToRemove = document.getElementById(`project-row-${id}`);
                 if(rowToRemove) rowToRemove.remove();

                 showMessage('Проект удален.', 'success');
            } catch (error) {
                 showMessage(error.message, 'error');
            }
        }

        // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---

        // Показать форму для создания
        function showCreateForm() {
            document.getElementById('formTitle').textContent = 'Новый проект';
            resetForm();
            loadLeadersForSelect(); // Загружаем список руководителей
            document.getElementById('projectForm').style.display = 'block';
        }

        // Скрыть форму
        function hideForm() {
            document.getElementById('projectForm').style.display = 'none';
            resetForm();
        }

        // Сброс полей формы
        function resetForm() {
             document.getElementById('projectId').value = '';
             document.getElementById('projectName').value = '';
             document.getElementById('projectNumber').value = '';
             document.getElementById('projectFundingOrg').value = '';
             document.getElementById('projectStartDate').value = '';
             document.getElementById('projectLeaderId').innerHTML = ''; // Очищаем список
        }

        // Загрузка списка преподавателей для select
        async function loadLeadersForSelect() {
            try {
                const response = await fetch(teachersApiUrl);
                if (!response.ok) throw new Error('Не удалось загрузить список руководителей');
                const teachers = await response.json();

                const select = document.getElementById('projectLeaderId');
                select.innerHTML = '<option value="">-- Выберите руководителя --</option>'; 

                teachers.forEach(teacher => {
                    select.innerHTML += `<option value="${teacher.teacherId}">${teacher.fullName}</option>`;
                });
            } catch (error) {
                console.error(error);
                document.getElementById('projectLeaderId').innerHTML = '<option value="">Ошибка загрузки</option>';
            }
        }

        // Показать сообщение
        function showMessage(text, type = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => { messageDiv.style.display = 'none'; }, 4000);
        }

        // --- ЗАПУСК ПРИ ЗАГРУЗКЕ СТРАНИЦЫ ---
        document.addEventListener("DOMContentLoaded", loadProjects);

    </script>
</body>
</html>